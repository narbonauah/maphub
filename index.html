<!DOCTYPE html>
<html lang="es">
<head>
  <title>MapHub</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { 
      margin: 0; 
      font-family: Arial, sans-serif;
    }
    #map { 
      height: 85vh; 
    }
    #filtros { 
      padding: 15px; 
      background: #f9f9f9;
      border-bottom: 1px solid #ccc;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 10px;
    }
    #filtros label { 
      font-weight: bold;
    }
    #filtros input, #filtros select {
      padding: 5px;
      border: 1px solid #ccc;
      border-radius: 3px;
    }
    #filtros button {
      padding: 8px 16px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
    }
    #filtros button:hover {
      background: #0056b3;
    }
    #contador {
      margin-left: auto;
      font-weight: bold;
      color: #666;
    }
    @media (max-width: 768px) {
      #filtros {
        flex-direction: column;
        align-items: stretch;
      }
      #contador {
        margin-left: 0;
        text-align: center;
      }
    }
  </style>
</head>
<body>
  <div id="filtros">
    <label for="fechaInicio">Desde:</label>
    <input type="date" id="fechaInicio" />
    
    <label for="fechaFin">Hasta:</label>
    <input type="date" id="fechaFin" />
    
    <label for="tipo">Tipo:</label>
    <select id="tipo">
      <option value="">Todos</option>
    </select>
    
    <button onclick="filtrar()">Filtrar</button>
    <div id="contador">0 eventos</div>
  </div>
  
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    const toNum = (v) => {
      if (v === null || v === undefined) return NaN;
      return parseFloat(String(v).replace(',', '.'));
    };

    const parseFecha = (s) => {
      if (!s) return null;
      s = String(s).trim();
      
      // Formato ISO: YYYY-MM-DD - Evitar problemas de zona horaria
      if (/^\d{4}-\d{2}-\d{2}$/.test(s)) {
        const [year, month, day] = s.split('-').map(num => parseInt(num, 10));
        const d = new Date(year, month - 1, day); // Usar constructor local, no UTC
        return isNaN(d) ? null : d;
      }
      
      // Formato DD/MM/YYYY o MM/DD/YYYY
      const m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2,4})$/);
      if (m) {
        const dd = parseInt(m[1], 10);
        const mm = parseInt(m[2], 10) - 1;
        let yyyy = parseInt(m[3], 10);
        if (yyyy < 100) yyyy += 2000;
        const d = new Date(yyyy, mm, dd);
        return isNaN(d) ? null : d;
      }
      
      // Para otros formatos, intentar parsing directo pero cuidado con UTC
      const d = new Date(s);
      if (isNaN(d)) return null;
      
      // Si parece ser una fecha ISO, ajustar para evitar desfase UTC
      if (s.includes('T') || s.includes('Z')) {
        return d;
      } else {
        // Para fechas sin hora, usar hora local
        const localDate = new Date(d.getTime() + d.getTimezoneOffset() * 60000);
        return localDate;
      }
    };

    const normalizeRow = (row) => {
      const lower = {};
      Object.keys(row).forEach(k => lower[k.toLowerCase().trim()] = row[k]);

      const pick = (...candidatos) => {
        for (const c of candidatos) {
          if (c in lower && String(lower[c]).trim() !== "") return lower[c];
        }
        for (const key of Object.keys(lower)) {
          if (candidatos.some(c => key.includes(c))) {
            if (String(lower[key]).trim() !== "") return lower[key];
          }
        }
        return "";
      };

      const nombre = pick('nombre', 't칤tulo', 'titulo', 'evento', 'name');
      const tipo = String(pick('tipo', 'categoria', 'type')).trim();
      const fechaStr = pick('fecha', 'date', 'fecha_evento');
      const hora = pick('hora', 'time');
      const recinto = pick('recinto', 'venue', 'lugar', 'site', 'ubicacion', 'ubicaci칩n');
      const desc = pick('descripcion', 'descripci칩n', 'description', 'desc');
      const link = pick('link', 'enlace', 'url');
      const lat = toNum(pick('lat', 'latitud', 'latitude'));
      const lon = toNum(pick('lon', 'lng', 'long', 'longitud', 'longitude'));
      const fecha = parseFecha(fechaStr);

      return { nombre, tipo, fecha, hora, recinto, descripcion: desc, link, lat, lon };
    };

    // Variables globales
    var map;
    var eventos = [];
    var markers = [];
    var sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQBgXQLiwgo23JJkp2QIOxK5OnMu-VCDTAghFzf0-C5S7gZGKe1Oi5sclWg2gWi1UM1N4Luxsd0zrY4/pub?output=csv";

    const setDefaultDates = () => {
      const hoy = new Date();
      const unMes = new Date();
      unMes.setMonth(unMes.getMonth() + 1);
      
      const formatearFecha = (fecha) => {
        const a침o = fecha.getFullYear();
        const mes = String(fecha.getMonth() + 1).padStart(2, '0');
        const dia = String(fecha.getDate()).padStart(2, '0');
        return `${a침o}-${mes}-${dia}`;
      };
      
      document.getElementById("fechaInicio").value = formatearFecha(hoy);
      document.getElementById("fechaFin").value = formatearFecha(unMes);
    };

    const updateCounter = (count) => {
      const contador = document.getElementById("contador");
      contador.textContent = `${count} evento${count !== 1 ? 's' : ''}`;
    };

    function inicializarMapa() {
      map = L.map('map').setView([40.4167, -3.70325], 6);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '춸 OpenStreetMap contributors'
      }).addTo(map);
    }

    function cargarDatos() {
      Papa.parse(sheetUrl, {
        download: true,
        header: true,
        skipEmptyLines: 'greedy',
        complete: function(results) {
          try {
            console.log("Datos recibidos:", results.data.length);
            
            eventos = results.data
              .map(normalizeRow)
              .filter(e => Number.isFinite(e.lat) && Number.isFinite(e.lon) && e.nombre);

            console.log("Eventos v치lidos:", eventos.length);

            const tipos = [...new Set(eventos.map(e => e.tipo).filter(t => t && t.trim() !== ""))].sort();
            const selectTipo = document.getElementById("tipo");
            
            tipos.forEach(t => {
              const opt = document.createElement("option");
              opt.value = t;
              opt.textContent = t;
              selectTipo.appendChild(opt);
            });

            // Event listeners
            document.getElementById("tipo").addEventListener("change", filtrar);
            document.getElementById("fechaInicio").addEventListener("change", filtrar);
            document.getElementById("fechaFin").addEventListener("change", filtrar);

            filtrar();
          } catch (error) {
            console.error("Error procesando datos:", error);
            alert("Error al procesar los datos");
          }
        },
        error: function(error) {
          console.error("Error cargando datos:", error);
          alert("Error al cargar los datos. Verifica la conexi칩n a internet.");
        }
      });
    }

    function mostrarEventos(fechaInicio = null, fechaFin = null, tipo = null) {
      // Limpiar marcadores anteriores
      markers.forEach(m => map.removeLayer(m));
      markers = [];

      const bounds = [];
      let eventosVisibles = 0;

      eventos.forEach(e => {
        // Filtro por tipo
        if (tipo && String(e.tipo) !== String(tipo)) return;
        
        // Filtro por fecha de inicio
        if (fechaInicio) {
          const fi = parseFecha(fechaInicio);
          if (fi && e.fecha && e.fecha < fi) return;
        }
        
        // Filtro por fecha de fin
        if (fechaFin) {
          const ff = parseFecha(fechaFin);
          if (ff && e.fecha && e.fecha > ff) return;
        }

        eventosVisibles++;

        let fechaTexto = "Sin fecha";
        if (e.fecha) {
          // Formatear fecha local sin problemas de zona horaria
          const dia = String(e.fecha.getDate()).padStart(2, '0');
          const mes = String(e.fecha.getMonth() + 1).padStart(2, '0');
          const a침o = e.fecha.getFullYear();
          fechaTexto = `${dia}/${mes}/${a침o}`;
        }
        
        const popup =
          `<b>${e.nombre}</b><br>` +
          `<b>Recinto:</b> ${e.recinto || "Sin especificar"}<br>` +
          `<b>Fecha:</b> ${fechaTexto}<br>` +
          `<b>Hora:</b> ${e.hora || "Sin especificar"}<br>` +
          `${e.tipo ? `<b>Tipo:</b> ${e.tipo}<br>` : ""}` +
          `${e.descripcion ? `<br>${e.descripcion}` : ""}` +
          `${e.link ? `<br><a href="${e.link}" target="_blank" rel="noopener">游댕 M치s info</a>` : ""}`;

        const marker = L.marker([e.lat, e.lon]).addTo(map).bindPopup(popup);
        markers.push(marker);
        bounds.push([e.lat, e.lon]);
      });

      // Ajustar vista del mapa
      if (bounds.length > 0) {
        map.fitBounds(bounds, { padding: [30, 30] });
      }

      updateCounter(eventosVisibles);
    }

    function filtrar() {
      const inicio = document.getElementById("fechaInicio").value;
      const fin = document.getElementById("fechaFin").value;
      const tipo = document.getElementById("tipo").value;
      console.log("Filtrando con:", { inicio, fin, tipo });
      mostrarEventos(inicio, fin, tipo);
    }

    // Inicializaci칩n cuando la p치gina est칠 lista
    window.onload = function() {
      console.log("Inicializando aplicaci칩n...");
      setDefaultDates();
      inicializarMapa();
      cargarDatos();
    };
  </script>
</body>
</html>
