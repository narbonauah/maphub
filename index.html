<!DOCTYPE html>
<html>
<head>
  <title>MapHub</title>
  <meta charset="utf-8" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body { margin: 0; font-family: sans-serif; }
    #map { height: 85vh; }
    #filtros { padding: 10px; background: #f9f9f9; border-bottom: 1px solid #ccc; }
    label { margin-right: 10px; }
  </style>
</head>
<body>
  <div id="filtros">
    <label for="fechaInicio">Desde: </label>
    <input type="date" id="fechaInicio" />
    <label for="fechaFin">Hasta: </label>
    <input type="date" id="fechaFin" />
    <label for="tipo">Tipo: </label>
    <select id="tipo">
      <option value="">Todos</option>
    </select>
    <button onclick="filtrar()">Filtrar</button>
  </div>
  <div id="map"></div>

  <script>
    const toNum = (v) => {
      if (v === null || v === undefined) return NaN;
      return parseFloat(String(v).replace(',', '.'));
    };

    const parseFecha = (s) => {
      if (!s) return null;
      s = String(s).trim();
      if (/^\d{4}-\d{2}-\d{2}$/.test(s)) {
        const d = new Date(s + "T00:00:00");
        return isNaN(d) ? null : d;
      }
      const m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2,4})$/);
      if (m) {
        const dd = parseInt(m[1], 10);
        const mm = parseInt(m[2], 10) - 1;
        let yyyy = parseInt(m[3], 10);
        if (yyyy < 100) yyyy += 2000;
        const d = new Date(yyyy, mm, dd);
        return isNaN(d) ? null : d;
      }
      const d = new Date(s);
      return isNaN(d) ? null : d;
    };

    const normalizeRow = (row) => {
      const lower = {};
      Object.keys(row).forEach(k => lower[k.toLowerCase().trim()] = row[k]);

      const pick = (...candidatos) => {
        for (const c of candidatos) {
          if (c in lower && String(lower[c]).trim() !== "") return lower[c];
        }
        for (const key of Object.keys(lower)) {
          if (candidatos.some(c => key.includes(c))) {
            if (String(lower[key]).trim() !== "") return lower[key];
          }
        }
        return "";
      };

      const nombre = pick('nombre', 't√≠tulo', 'titulo', 'evento', '
