<!DOCTYPE html>
<html>
<head>
  <title>MapHub</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body { margin: 0; font-family: sans-serif; display: flex; height: 100vh; }

    /* Sidebar */
    #filtros {
      width: 250px;
      padding: 10px;
      background: #f9f9f9;
      border-right: 1px solid #ccc;
      display: flex;
      flex-direction: column;
      gap: 10px;
      transition: transform 0.3s ease;
    }
    #filtros.hidden {
      transform: translateX(-100%);
    }

    #filtros input, #filtros select, #filtros button {
      padding: 5px;
      font-size: 14px;
      width: 100%;
    }

    #map { flex: 1; }

    /* BotÃ³n menÃº en mÃ³vil */
    #menuBtn {
      display: none;
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: white;
      border: 1px solid #ccc;
      border-radius: 5px;
      padding: 6px 10px;
      font-size: 18px;
      cursor: pointer;
    }

    @media (max-width: 768px) {
      body { flex-direction: column; }
      #filtros {
        position: absolute;
        top: 0; left: 0; bottom: 0;
        width: 250px;
        z-index: 999;
        background: #fff;
        box-shadow: 2px 0 5px rgba(0,0,0,0.2);
      }
      #menuBtn { display: block; }
      #map { flex: 1; }
    }

    /* Leyenda */
    .legend {
      background: white;
      padding: 8px;
      line-height: 20px;
      border-radius: 5px;
      font-size: 13px;
    }
    .legend img {
      vertical-align: middle;
      margin-right: 5px;
      width: 18px;
      height: 18px;
    }
  </style>
</head>
<body>
  <button id="menuBtn">â˜°</button>
  <div id="filtros" class="hidden">
    <label for="fechaInicio">Desde:</label>
    <input type="date" id="fechaInicio" />
    <label for="fechaFin">Hasta:</label>
    <input type="date" id="fechaFin" />
    <label for="tipo">Tipo:</label>
    <select id="tipo">
      <option value="">Todos</option>
    </select>
    <button onclick="filtrar()">Filtrar</button>
  </div>
  <div id="map"></div>

  <script>
    // --- Utilidades ---
    const toNum = (v) => {
      if (v === null || v === undefined) return NaN;
      return parseFloat(String(v).replace(',', '.'));
    };

    const parseFecha = (s) => {
      if (!s) return null;
      const d = new Date(s);
      return isNaN(d) ? null : d;
    };

    const normalizeRow = (row) => {
      const lower = {};
      Object.keys(row).forEach(k => lower[k.toLowerCase().trim()] = row[k]);

      const pick = (...candidatos) => {
        for (const c of candidatos) {
          if (c in lower && String(lower[c]).trim() !== "") return lower[c];
        }
        for (const key of Object.keys(lower)) {
          if (candidatos.some(c => key.includes(c))) {
            if (String(lower[key]).trim() !== "") return lower[key];
          }
        }
        return "";
      };

      const nombre = pick('nombre', 'evento', 'titulo', 'name');
      const tipo = String(pick('tipo', 'categoria', 'type')).trim();
      const fechaStr = pick('fecha', 'date');
      const hora = pick('hora', 'time');
      const recinto = pick('recinto', 'lugar', 'venue');
      const desc = pick('descripcion', 'descripciÃ³n', 'description');
      const link = pick('link', 'url');
      const lat = toNum(pick('lat', 'latitud'));
      const lon = toNum(pick('lon', 'lng', 'longitud'));
      const fecha = parseFecha(fechaStr);

      return { nombre, tipo, fecha, hora, recinto, descripcion: desc, link, lat, lon };
    };

    // --- Mapa ---
    var map = L.map('map').setView([40.4167, -3.70325], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    // --- Iconos personalizados ---
    const iconos = {
      FUTBOL: L.icon({
        iconUrl: "https://cdn-icons-png.flaticon.com/512/3011/3011346.png", // âš½
        iconSize: [32, 32],
        iconAnchor: [16, 32],
        popupAnchor: [0, -32]
      }),
      CONCIERTO: L.icon({
        iconUrl: "https://cdn-icons-png.flaticon.com/512/727/727240.png", // ðŸŽµ
        iconSize: [32, 32],
        iconAnchor: [16, 32],
        popupAnchor: [0, -32]
      }),
      OTROS: L.icon({
        iconUrl: "https://maps.google.com/mapfiles/ms/icons/red-dot.png",
        iconSize: [32, 32],
        iconAnchor: [16, 32],
        popupAnchor: [0, -32]
      }),
      DEFAULT: L.icon({
        iconUrl: "https://maps.google.com/mapfiles/ms/icons/yellow-dot.png",
        iconSize: [32, 32],
        iconAnchor: [16, 32],
        popupAnchor: [0, -32]
      })
    };

    var eventos = [];
    var markers = [];
    var sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQBgXQLiwgo23JJkp2QIOxK5OnMu-VCDTAghFzf0-C5S7gZGKe1Oi5sclWg2gWi1UM1N4Luxsd0zrY4/pub?output=csv";

    const setDefaultDates = () => {
      let hoy = new Date();
      let unMes = new Date(hoy);
      unMes.setMonth(unMes.getMonth() + 1);
      const fmt = (d) => d.toISOString().split("T")[0];
      document.getElementById("fechaInicio").value = fmt(hoy);
      document.getElementById("fechaFin").value = fmt(unMes);
    };
    setDefaultDates();

    Papa.parse(sheetUrl, {
      download: true,
      header: true,
      skipEmptyLines: 'greedy',
      complete: function(results) {
        eventos = results.data
          .map(normalizeRow)
          .filter(e => Number.isFinite(e.lat) && Number.isFinite(e.lon) && e.nombre);

        // Rellenar selector de tipo
        const tipos = [...new Set(eventos.map(e => e.tipo).filter(t => t))].sort();
        const selectTipo = document.getElementById("tipo");
        tipos.forEach(t => {
          const opt = document.createElement("option");
          opt.value = t;
          opt.textContent = t;
          selectTipo.appendChild(opt);
        });

        document.getElementById("tipo").addEventListener("change", filtrar);
        document.getElementById("fechaInicio").addEventListener("change", filtrar);
        document.getElementById("fechaFin").addEventListener("change", filtrar);

        filtrar();
      }
    });

    function mostrarEventos(fechaInicio = null, fechaFin = null, tipo = null) {
      markers.forEach(m => map.removeLayer(m));
      markers = [];

      const fi = parseFecha(fechaInicio);
      const ff = parseFecha(fechaFin);
      const bounds = [];

      eventos.forEach(e => {
        if (tipo && e.tipo !== tipo) return;
        if (fi && e.fecha && e.fecha < fi) return;
        if (ff && e.fecha && e.fecha > ff) return;

        const fechaTexto = e.fecha ? e.fecha.toISOString().split("T")[0] : "";
        const popup =
          `<b>${e.nombre}</b><br>` +
          `<b>Recinto:</b> ${e.recinto || "Sin especificar"}<br>` +
          `<b>Fecha:</b> ${fechaTexto}<br>` +
          `<b>Hora:</b> ${e.hora || "Sin especificar"}<br>` +
          `${e.descripcion ? `<br>${e.descripcion}` : ""}` +
          `${e.link ? `<br><a href="${e.link}" target="_blank">ðŸ”— MÃ¡s info</a>` : ""}`;

        const icon = iconos[e.tipo] || iconos.DEFAULT;

        const marker = L.marker([e.lat, e.lon], { icon }).addTo(map).bindPopup(popup);
        markers.push(marker);
        bounds.push([e.lat, e.lon]);
      });

      if (bounds.length) map.fitBounds(bounds, { padding: [30, 30] });
    }

    function filtrar() {
      const inicio = document.getElementById("fechaInicio").value;
      const fin = document.getElementById("fechaFin").value;
      const tipo = document.getElementById("tipo").value;
      mostrarEventos(inicio, fin, tipo);
    }

    // --- Sidebar toggle en mÃ³vil ---
    const menuBtn = document.getElementById("menuBtn");
    const filtros = document.getElementById("filtros");
    menuBtn.addEventListener("click", () => {
      filtros.classList.toggle("hidden");
    });

    // --- Leyenda ---
    const legend = L.control({ position: "bottomright" });
    legend.onAdd = function () {
      const div = L.DomUtil.create("div", "legend");
      div.innerHTML = `
        <b>Leyenda</b><br>
        <img src="https://cdn-icons-png.flaticon.com/512/3011/3011346.png"> FÃºtbol<br>
        <img src="https://cdn-icons-png.flaticon.com/512/727/727240.png"> Concierto<br>
        <img src="https://maps.google.com/mapfiles/ms/icons/red-dot.png"> Otros<br>
        <img src="https://maps.google.com/mapfiles/ms/icons/yellow-dot.png"> Resto
      `;
      return div;
    };
    legend.addTo(map);
  </script>
</body>
</html>
