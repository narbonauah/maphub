<!DOCTYPE html>
<html>
<head>
  <title>MapHub</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

  <!-- AwesomeMarkers + FontAwesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.awesome-markers/2.0.4/leaflet.awesome-markers.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.awesome-markers/2.0.4/leaflet.awesome-markers.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

  <style>
    body { margin: 0; font-family: sans-serif; display: flex; height: 100vh; }
    #filtros {
      width: 250px;
      padding: 10px;
      background: #f9f9f9;
      border-right: 1px solid #ccc;
      display: flex;
      flex-direction: column;
      gap: 10px;
      transition: transform 0.3s ease;
      z-index: 2000;
      position: relative;
    }
    #filtros.hidden { transform: translateX(-100%); }
    #map { flex: 1; position: relative; z-index: 1; }
    #menuBtn {
      display: none;
      position: absolute;
      top: 10px; left: 10px;
      z-index: 2100;
      background: white;
      border: 1px solid #ccc;
      border-radius: 5px;
      padding: 6px 10px;
      font-size: 18px;
      cursor: pointer;
    }
    @media (max-width: 768px) {
      body { flex-direction: column; }
      #filtros {
        position: absolute;
        top: 0; left: 0; bottom: 0;
        width: 250px;
        z-index: 2000;
        box-shadow: 2px 0 5px rgba(0,0,0,0.2);
      }
      #menuBtn { display: block; }
      #map { flex: 1; }
    }
    .legend {
      background: white;
      padding: 8px;
      line-height: 20px;
      border-radius: 5px;
      font-size: 13px;
      z-index: 2000;
    }
    .legend i {
      width: 18px; height: 18px;
      text-align: center;
      margin-right: 5px;
    }
  </style>
</head>
<body>
  <button id="menuBtn">â˜°</button>
  <div id="filtros" class="">
    <label for="fechaInicio">Desde:</label>
    <input type="date" id="fechaInicio" />
    <label for="fechaFin">Hasta:</label>
    <input type="date" id="fechaFin" />
    <label for="tipo">Tipo:</label>
    <select id="tipo">
      <option value="">Todos</option>
    </select>
    <button onclick="filtrar()">Filtrar</button>
  </div>
  <div id="map"></div>

  <script>
    document.addEventListener("DOMContentLoaded", function(){

      // --- Utilidades ---
      const toNum = (v) => { if (v === null || v === undefined) return NaN; return parseFloat(String(v).replace(',', '.')); };
      const parseFecha = (s) => { if (!s) return null; const d = new Date(s); return isNaN(d) ? null : d; };
      const normalizeRow = (row) => {
        const lower = {}; Object.keys(row).forEach(k => lower[k.toLowerCase().trim()] = row[k]);
        const pick = (...c) => { for (const k of c) if (k in lower && String(lower[k]).trim() !== "") return lower[k]; return ""; };
        return {
          nombre: pick('nombre','evento','titulo'),
          tipo: pick('tipo','categoria'),
          fecha: parseFecha(pick('fecha','date')),
          hora: pick('hora','time'),
          recinto: pick('recinto','lugar','venue'),
          descripcion: pick('descripcion','description'),
          link: pick('link','url'),
          lat: toNum(pick('lat','latitud')),
          lon: toNum(pick('lon','longitud','lng'))
        };
      };

      // --- Mapa ---
      var map = L.map('map', { zoomControl: false }).setView([40.4167, -3.70325], 6);
      L.control.zoom({ position: 'topright' }).addTo(map);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
      }).addTo(map);

      // --- Iconos ---
      const iconos = {
        FUTBOL: L.AwesomeMarkers.icon({ icon: 'futbol', prefix: 'fa', markerColor: 'green' }),
        CONCIERTO: L.AwesomeMarkers.icon({ icon: 'music', prefix: 'fa', markerColor: 'blue' }),
        OTROS: L.AwesomeMarkers.icon({ icon: 'star', prefix: 'fa', markerColor: 'red' }),
        DEFAULT: L.AwesomeMarkers.icon({ icon: 'info', prefix: 'fa', markerColor: 'orange' })
      };

      var eventos = [], markers = [];
      var sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQBgXQLiwgo23JJkp2QIOxK5OnMu-VCDTAghFzf0-C5S7gZGKe1Oi5sclWg2gWi1UM1N4Luxsd0zrY4/pubhtml";

      // --- Fechas por defecto ---
      const setDefaultDates = () => {
        let hoy = new Date();
        let unMes = new Date(hoy); unMes.setMonth(unMes.getMonth()+1);
        const fmt = (d) => d.toISOString().split("T")[0];
        document.getElementById("fechaInicio").value = fmt(hoy);
        document.getElementById("fechaFin").value = fmt(unMes);
      };
      setDefaultDates();

      // --- Cargar Google Sheets ---
      Papa.parse(sheetUrl, {
        download: true,
        header: true,
        skipEmptyLines: 'greedy',
        complete: function(results){
          eventos = results.data.map(normalizeRow).filter(e => Number.isFinite(e.lat) && Number.isFinite(e.lon) && e.nombre);

          // Rellenar selector de tipo
          const tipos = [...new Set(eventos.map(e => e.tipo).filter(t=>t))].sort();
          const selectTipo = document.getElementById("tipo");
          tipos.forEach(t=>{
            const opt = document.createElement("option");
            opt.value=t; opt.textContent=t; selectTipo.appendChild(opt);
          });

          // Filtrado dinÃ¡mico
          document.getElementById("tipo").addEventListener("change", filtrar);
          document.getElementById("fechaInicio").addEventListener("change", filtrar);
          document.getElementById("fechaFin").addEventListener("change", filtrar);

          filtrar();
        }
      });

      // --- Mostrar eventos ---
      function mostrarEventos(fechaInicio, fechaFin, tipo){
        markers.forEach(m=>map.removeLayer(m)); markers=[];
        const fi=parseFecha(fechaInicio), ff=parseFecha(fechaFin); const bounds=[];
        eventos.forEach(e=>{
          if(tipo && e.tipo!==tipo) return;
          if(fi && e.fecha && e.fecha<fi) return;
          if(ff && e.fecha && e.fecha>ff) return;
          const fechaTexto = e.fecha?e.fecha.toISOString().split("T")[0]:"";
          const popup = `<b>${e.nombre}</b><br>`+
                        `<b>Recinto:</b> ${e.recinto || "Sin especificar"}<br>`+
                        `<b>Fecha:</b> ${fechaTexto}<br>`+
                        `<b>Hora:</b> ${e.hora || "Sin especificar"}<br>`+
                        `${e.descripcion?`<br>${e.descripcion}`:""}`+
                        `${e.link?`<br><a href="${e.link}" target="_blank">ðŸ”— MÃ¡s info</a>`:""}`;
          const icon = iconos[e.tipo]||iconos.DEFAULT;
          const marker = L.marker([e.lat,e.lon],{icon}).addTo(map).bindPopup(popup);
          markers.push(marker); bounds.push([e.lat
