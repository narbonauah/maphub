<!DOCTYPE html>
<html>
<head>
  <title>Mapa de Eventos</title>
  <meta charset="utf-8" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body { margin: 0; font-family: sans-serif; }
    #map { height: 85vh; }
    #filtros { padding: 10px; background: #f9f9f9; border-bottom: 1px solid #ccc; }
    label { margin-right: 10px; }
  </style>
</head>
<body>
  <div id="filtros">
    <label for="fechaInicio">Desde: </label>
    <input type="date" id="fechaInicio" />
    <label for="fechaFin">Hasta: </label>
    <input type="date" id="fechaFin" />
    <label for="tipo">Tipo: </label>
    <select id="tipo">
      <option value="">Todos</option>
    </select>
    <!-- BotÃ³n opcional: lo dejamos por si quieres usarlo manualmente -->
    <button onclick="filtrar()">Filtrar</button>
  </div>
  <div id="map"></div>

  <script>
    // --------- Helpers robustos ---------
    const toNum = (v) => {
      if (v === null || v === undefined) return NaN;
      return parseFloat(String(v).replace(',', '.'));
    };

    // Acepta "YYYY-MM-DD" o "DD/MM/YYYY"
    const parseFecha = (s) => {
      if (!s) return null;
      s = String(s).trim();
      // ISO
      if (/^\d{4}-\d{2}-\d{2}$/.test(s)) {
        const d = new Date(s + "T00:00:00");
        return isNaN(d) ? null : d;
      }
      // dd/mm/yyyy (asumimos ES)
      const m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2,4})$/);
      if (m) {
        const dd = parseInt(m[1], 10);
        const mm = parseInt(m[2], 10) - 1;
        let yyyy = parseInt(m[3], 10);
        if (yyyy < 100) yyyy += 2000; // 25 -> 2025
        const d = new Date(yyyy, mm, dd);
        return isNaN(d) ? null : d;
      }
      // Ãšltimo intento: Date nativo
      const d = new Date(s);
      return isNaN(d) ? null : d;
    };

    // Normaliza claves de una fila (admite sinonimias comunes)
    const normalizeRow = (row) => {
      // Mapa por heurÃ­stica (claves en minÃºsculas)
      const lower = {};
      Object.keys(row).forEach(k => lower[k.toLowerCase().trim()] = row[k]);

      const pick = (...candidatos) => {
        for (const c of candidatos) {
          if (c in lower && String(lower[c]).trim() !== "") return lower[c];
        }
        // bÃºsqueda heurÃ­stica por contiene
        for (const key of Object.keys(lower)) {
          if (candidatos.some(c => key.includes(c))) {
            if (String(lower[key]).trim() !== "") return lower[key];
          }
        }
        return "";
      };

      const nombre = pick('nombre', 'tÃ­tulo', 'titulo', 'evento', 'name');
      const tipo = String(pick('tipo', 'categoria', 'type')).trim();
      const fechaStr = pick('fecha', 'date', 'fecha_evento');
      const hora = pick('hora', 'time');
      const recinto = pick('recinto', 'venue', 'lugar', 'site', 'ubicacion', 'ubicaciÃ³n');
      const desc = pick('descripcion', 'descripciÃ³n', 'description', 'desc');
      const link = pick('link', 'enlace', 'url');

      // lat / lon con variantes
      const latRaw = pick('lat', 'latitud', 'latitude');
      const lonRaw = pick('lon', 'lng', 'long', 'longitud', 'longitude');

      const lat = toNum(latRaw);
      const lon = toNum(lonRaw);

      const fecha = parseFecha(fechaStr);

      return { nombre, tipo, fecha, hora, recinto, descripcion: desc, link, lat, lon };
    };

    // --------- Mapa ---------
    var map = L.map('map').setView([40.4167, -3.70325], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    var eventos = [];
    var markers = [];

    // Tu Google Sheet (CSV publicado)
    var sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQBgXQLiwgo23JJkp2QIOxK5OnMu-VCDTAghFzf0-C5S7gZGKe1Oi5sclWg2gWi1UM1N4Luxsd0zrY4/pub?output=csv";

    // Fechas por defecto (hoy y +1 mes)
    const setDefaultDates = () => {
      let hoy = new Date();
      let unMes = new Date(hoy);
      unMes.setMonth(unMes.getMonth() + 1);
      const fmt = (d) => {
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const dd = String(d.getDate()).padStart(2, '0');
        return `${yyyy}-${mm}-${dd}`;
      };
      document.getElementById("fechaInicio").value = fmt(hoy);
      document.getElementById("fechaFin").value = fmt(unMes);
    };
    setDefaultDates();

    // Cargar Sheet
    Papa.parse(sheetUrl, {
      download: true,
      header: true,
      skipEmptyLines: 'greedy',
      complete: function(results) {
        // Normalizamos y filtramos filas vÃ¡lidas
        eventos = results.data
          .map(normalizeRow)
          .filter(e => Number.isFinite(e.lat) && Number.isFinite(e.lon) && e.nombre);

        if (!eventos.length) {
          console.warn("No se han encontrado eventos vÃ¡lidos. Revisa nombres de columnas y datos.");
        }

        // Poblar selector tipo (valores Ãºnicos limpios)
        const tipos = [...new Set(eventos.map(e => e.tipo).filter(t => t && t.trim() !== ""))].sort();
        const selectTipo = document.getElementById("tipo");
        tipos.forEach(t => {
          const opt = document.createElement("option");
          opt.value = t;
          opt.textContent = t;
          selectTipo.appendChild(opt);
        });

        // Listeners: disparan filtro automÃ¡ticamente
        document.getElementById("tipo").addEventListener("change", filtrar);
        document.getElementById("fechaInicio").addEventListener("change", filtrar);
        document.getElementById("fechaFin").addEventListener("change", filtrar);

        // Pintado inicial
        filtrar();
      },
      error: function(err) {
        console.error("Error cargando CSV de Google Sheets:", err);
        alert("No se pudo cargar el CSV de Google Sheets. Verifica que estÃ© 'Publicado en la web' como CSV.");
      }
    });

    function mostrarEventos(fechaInicio = null, fechaFin = null, tipo = null) {
      // Limpiar marcadores
      markers.forEach(m => map.removeLayer(m));
      markers = [];

      const bounds = [];
      eventos.forEach(e => {
        // Filtros
        if (tipo && String(e.tipo) !== String(tipo)) return;

        if (fechaInicio) {
          const fi = parseFecha(fechaInicio);
          if (fi && e.fecha && e.fecha < fi) return;
        }
        if (fechaFin) {
          const ff = parseFecha(fechaFin);
          if (ff && e.fecha && e.fecha > ff) return;
        }

        const popup =
          `<b>${e.nombre}</b><br>` +
          `${e.tipo ? e.tipo + " - " : ""}${e.fecha ? e.fecha.toISOString().slice(0,10) : ""} ${e.hora || ""}<br>` +
          `<b>Recinto:</b> ${e.recinto || "Sin especificar"}<br>` +
          `${e.descripcion ? e.descripcion : ""}` +
          `${e.link ? `<br><a href="${e.link}" target="_blank" rel="noopener">ðŸ”— MÃ¡s info</a>` : ""}`;

        const marker = L.marker([e.lat, e.lon]).addTo(map).bindPopup(popup);
        markers.push(marker);
        bounds.push([e.lat, e.lon]);
      });

      if (bounds.length) {
        map.fitBounds(bounds, { padding: [30, 30] });
      }
    }

    function filtrar() {
      const inicio = document.getElementById("fechaInicio").value;
      const fin = document.getElementById("fechaFin").value;
      const tipo = document.getElementById("tipo").value;
      mostrarEventos(inicio, fin, tipo);
    }
  </script>
</body>
</html>
